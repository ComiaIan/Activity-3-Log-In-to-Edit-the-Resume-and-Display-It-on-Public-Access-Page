<?php
session_start();
require 'db.php';

$stmt = $pdo->query("SELECT * FROM resume LIMIT 1");
$resume = $stmt->fetch(PDO::FETCH_ASSOC);

if (!$resume) die("No resume data found in the database.");

// Fetch skills (include id)
$stmt = $pdo->prepare("SELECT id, category, description FROM skills WHERE resume_id = :id");
$stmt->execute(['id' => $resume['id']]);
$skills = $stmt->fetchAll(PDO::FETCH_ASSOC);

// Fetch projects (include id)
$stmt = $pdo->prepare("SELECT id, title FROM projects WHERE resume_id = :id");
$stmt->execute(['id' => $resume['id']]);
$projects = $stmt->fetchAll(PDO::FETCH_ASSOC);

// Fetch project details
$projectData = [];
foreach ($projects as $proj) {
    $stmt = $pdo->prepare("SELECT id, detail FROM project_details WHERE project_id = :pid");
    $stmt->execute(['pid' => $proj['id']]);
    $details = $stmt->fetchAll(PDO::FETCH_ASSOC);
    $projectData[] = [
        'id' => $proj['id'],
        'title' => $proj['title'],
        'details' => $details
    ];
}

// Fetch education (include id)
$stmt = $pdo->prepare("SELECT id, institution, period, degree FROM education WHERE resume_id = :id");
$stmt->execute(['id' => $resume['id']]);
$education = $stmt->fetchAll(PDO::FETCH_ASSOC);

$isLoggedIn = isset($_SESSION['user']);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><?= htmlspecialchars($resume["name"]); ?> - CV</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:Arial, sans-serif;
            background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color:#333;
            min-height:100vh;
            padding:40px 20px;
        }
        .container {
            max-width:900px;
            margin:auto;
            background:rgba(255,255,255,0.95);
            backdrop-filter:blur(10px);
            padding:30px;
            border-radius:12px;
            box-shadow:0 20px 60px rgba(0,0,0,0.3);
        }
        h1, h2 { color:#2c3e50; }
        h1 { border-bottom:2px solid #2c3e50; padding-bottom:10px; margin-bottom:20px; }
        .section { margin-bottom:25px; }
        ul { margin:10px 0 0 20px; }
        .edit-controls {
            display:flex;
            justify-content:flex-end;
            gap:10px;
            margin-top:20px;
        }
        .btn { padding:10px 18px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
        .btn-confirm { background:#4CAF50; color:white; }
        .btn-cancel { background:#e74c3c; color:white; }
        input[type=text], textarea {
            width:100%;
            padding:8px;
            border:1px solid #ccc;
            border-radius:6px;
            margin-top:4px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="topbar" style="text-align:right;margin-bottom:20px;">
        <?php if ($isLoggedIn): ?>
            Welcome, <?= htmlspecialchars($_SESSION['user']); ?> |
            <a href="logout.php" style="text-decoration:none;color:white;background:#764ba2;padding:8px 16px;border-radius:6px;">Logout</a>
        <?php endif; ?>
    </div>

    <?php if ($isLoggedIn): ?><form method="POST" action="update_resume.php" id="resumeForm"><?php endif; ?>

    <!-- HEADER -->
    <h1>
        <?php if ($isLoggedIn): ?>
            <input type="text" name="name" value="<?= htmlspecialchars($resume['name']); ?>">
        <?php else: ?>
            <?= htmlspecialchars($resume["name"]); ?>
        <?php endif; ?>
    </h1>

    <div class="contact">
        <?php if ($isLoggedIn): ?>
            <label>Phone:</label>
            <input type="text" name="phone" value="<?= htmlspecialchars($resume['phone']); ?>"><br><br>
            <label>Email:</label>
            <input type="text" name="email" value="<?= htmlspecialchars($resume['email']); ?>"><br><br>
            <label>Address:</label>
            <input type="text" name="location" value="<?= htmlspecialchars($resume['location']); ?>">
        <?php else: ?>
            <p>ðŸ“ž <?= htmlspecialchars($resume["phone"]); ?> |
                <?= htmlspecialchars($resume["email"]); ?> |
                <?= htmlspecialchars($resume["location"]); ?></p>
        <?php endif; ?>
    </div>

    <!-- SUMMARY -->
    <div class="section">
        <h2>SUMMARY</h2>
        <?php if ($isLoggedIn): ?>
            <textarea name="summary" rows="4"><?= htmlspecialchars($resume['summary']); ?></textarea>
        <?php else: ?>
            <p><?= nl2br(htmlspecialchars($resume["summary"])); ?></p>
        <?php endif; ?>
    </div>

    <!-- SKILLS -->
    <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2>TECHNICAL SKILLS</h2>
            <?php if ($isLoggedIn): ?>
                <button type="button" onclick="addSkill()" style="background:#4CAF50;color:white;padding:8px 14px;border:none;border-radius:6px;">+ Add Skill</button>
            <?php endif; ?>
        </div>
        <ul>
            <?php foreach ($skills as $i => $skill): ?>
                <li style="list-style-type: disc; margin-left:20px;">
                    <?php if ($isLoggedIn): ?>
                        <input type="text" name="skills[<?= $skill['id'] ?>][category]" value="<?= htmlspecialchars($skill['category']); ?>" placeholder="Category">
                        <input type="text" name="skills[<?= $skill['id'] ?>][description]" value="<?= htmlspecialchars($skill['description']); ?>" placeholder="Description">
                        <button type="button" onclick="deleteSkill(<?= $skill['id'] ?>)" style="background:#e74c3c;color:white;padding:6px 10px;border:none;border-radius:4px;">Delete</button>
                    <?php else: ?>
                        <strong><?= htmlspecialchars($skill["category"]); ?>:</strong> <?= htmlspecialchars($skill["description"]); ?>
                    <?php endif; ?>
                </li>
            <?php endforeach; ?>
        </ul>
    </div>

    <!-- PROJECTS -->
    <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2>PROJECTS</h2>
            <?php if ($isLoggedIn): ?>
                <button type="button" onclick="addProject()" style="background:#4CAF50;color:white;padding:8px 14px;border:none;border-radius:6px;">+ Add Project</button>
            <?php endif; ?>
        </div>

        <?php foreach ($projectData as $p): ?>
        <div style="margin-bottom:20px;border-bottom:1px solid #ddd;padding-bottom:10px;">
            <p><strong>
                <?php if ($isLoggedIn): ?>
                    <input type="text" name="project_titles[<?= $p['id'] ?>]" value="<?= htmlspecialchars($p['title']); ?>">
                <?php else: ?>
                    <?= htmlspecialchars($p['title']); ?>
                <?php endif; ?>
            </strong></p>
            <ul id="details-<?= $p['id'] ?>">
                <?php foreach ($p['details'] as $detail): ?>
                    <li>
                        <?php if ($isLoggedIn): ?>
                            <input type="text" name="project_details[<?= $detail['id'] ?>]" value="<?= htmlspecialchars($detail['detail']); ?>" placeholder="Project detail...">
                        <?php else: ?>
                            <?= htmlspecialchars($detail['detail']); ?>
                        <?php endif; ?>
                    </li>
                <?php endforeach; ?>
            </ul>

            <?php if ($isLoggedIn): ?>
                <div style="display:flex;gap:10px;margin-top:8px;">
                    <input type="text" id="detail-input-<?= $p['id'] ?>" placeholder="New detail...">
                    <button type="button" onclick="addDetail(<?= $p['id'] ?>)" style="background:#3498db;color:white;padding:6px 12px;border:none;border-radius:6px;">+ Add Detail</button>
                    <button type="button" onclick="deleteProject(<?= $p['id'] ?>)" style="background:#e74c3c;color:white;padding:6px 12px;border:none;border-radius:6px;">Delete Project</button>
                </div>
            <?php endif; ?>
        </div>
        <?php endforeach; ?>
    </div>

    <!-- EDUCATION -->
    <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2>EDUCATION</h2>
            <?php if ($isLoggedIn): ?>
                <button type="button" onclick="addEducation()" style="background:#4CAF50;color:white;padding:8px 14px;border:none;border-radius:6px;">+ Add Education</button>
            <?php endif; ?>
        </div>

        <?php foreach ($education as $edu): ?>
            <div style="margin-bottom:15px;">
                <?php if ($isLoggedIn): ?>
                    <input type="text" name="education[<?= $edu['id'] ?>][institution]" value="<?= htmlspecialchars($edu['institution']); ?>" placeholder="Institution"><br>
                    <input type="text" name="education[<?= $edu['id'] ?>][period]" value="<?= htmlspecialchars($edu['period']); ?>" placeholder="Period"><br>
                    <input type="text" name="education[<?= $edu['id'] ?>][degree]" value="<?= htmlspecialchars($edu['degree']); ?>" placeholder="Degree"><br>
                    <button type="button" onclick="deleteEducation(<?= $edu['id'] ?>)" style="background:#e74c3c;color:white;padding:6px 12px;border:none;border-radius:6px;">Delete</button>
                <?php else: ?>
                    <p><strong><?= htmlspecialchars($edu["institution"]); ?></strong> (<?= htmlspecialchars($edu["period"]); ?>)<br><?= htmlspecialchars($edu["degree"]); ?></p>
                <?php endif; ?>
            </div>
        <?php endforeach; ?>
    </div>

    <?php if ($isLoggedIn): ?>
        <div class="edit-controls">
            <button type="button" class="btn btn-cancel" onclick="window.location.reload()">Cancel</button>
            <button type="submit" class="btn btn-confirm" onclick="cleanEmptyDetails()">Confirm</button>
        </div>
    </form>
    <?php endif; ?>
</div>

<script>
function cleanEmptyDetails() {
    // Automatically remove empty detail fields before submitting
    document.querySelectorAll('input[name^="project_details"]').forEach(el => {
        if (el.value.trim() === '') el.closest('li').remove();
    });
}

function addDetail(projectId) {
    const input = document.getElementById('detail-input-' + projectId);
    const detail = input.value.trim();
    if (!detail) return alert("Enter a detail first.");

    fetch('add_detail.php', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'project_id='+encodeURIComponent(projectId)+'&detail='+encodeURIComponent(detail)
    }).then(r=>r.ok?location.reload():alert("Error adding detail"));
}

function addProject() {
    const title = prompt("Enter project title:");
    if (!title) return;

    fetch('add_project.php', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'title='+encodeURIComponent(title)
    }).then(r=>r.ok?location.reload():alert("Error adding project"));
}

function deleteProject(id) {
    if (!confirm("Delete this project?")) return;
    fetch('delete_project.php', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'id='+encodeURIComponent(id)
    }).then(r=>r.ok?location.reload():alert("Error deleting project"));
}

function addSkill() {
    fetch('add_skill.php').then(r => r.ok ? location.reload() : alert("Error adding skill"));
}

function deleteSkill(id) {
    if (!confirm("Delete this skill?")) return;
    fetch('delete_skill.php', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'id='+encodeURIComponent(id)
    }).then(r=>r.ok?location.reload():alert("Error deleting skill"));
}

function addEducation() {
    fetch('add_education.php').then(r => r.ok ? location.reload() : alert("Error adding education"));
}

function deleteEducation(id) {
    if (!confirm("Delete this education entry?")) return;
    fetch('delete_education.php', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'id='+encodeURIComponent(id)
    }).then(r=>r.ok?location.reload():alert("Error deleting education"));
}
</script>
</body>
</html>
